<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>メールテンプレート管理 (Cloud)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <link rel="apple-touch-icon" href="mail-icon.png?v=2">
  <link rel="icon" type="image/png" href="mail-icon.png?v=2">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    window.FirebaseLib = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc };
  </script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    .pt-safe { padding-top: env(safe-area-inset-top); }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .animate-fade-in-up { animation: fadeInUp 0.3s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const Icon = ({ path, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
    );
    const Search = (p) => <Icon {...p} path={<g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></g>} />;
    const Copy = (p) => <Icon {...p} path={<g><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></g>} />;
    const Plus = (p) => <Icon {...p} path={<g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>} />;
    const Edit2 = (p) => <Icon {...p} path={<g><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></g>} />;
    const Trash2 = (p) => <Icon {...p} path={<g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2-2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>} />;
    const Check = (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />;
    const Send = (p) => <Icon {...p} path={<g><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></g>} />;
    const Folder = (p) => <Icon {...p} path={<g><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></g>} />;
    const MessageSquare = (p) => <Icon {...p} path={<g><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></g>} />;
    const Clock = (p) => <Icon {...p} path={<g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>} />;
    const RotateCcw = (p) => <Icon {...p} path={<g><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></g>} />;
    const Save = (p) => <Icon {...p} path={<g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></g>} />;
    const X = (p) => <Icon {...p} path={<g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>} />;
    const Menu = (p) => <Icon {...p} path={<g><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></g>} />;
    const Smartphone = (p) => <Icon {...p} path={<g><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></g>} />;
    const Settings = (p) => <Icon {...p} path={<g><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/><circle cx="12" cy="12" r="3"/></g>} />;
    const ChevronDown = (p) => <Icon {...p} path={<polyline points="6 9 12 15 18 9"/>} />;

    const CATEGORY_GROUPS = [
      { id: 'general', label: '', items: [{ id: 'all', name: 'すべて', icon: <Folder size={18} /> }] },
      { id: 'standard', label: '通常対応', items: [
        { id: 'initial', name: '初期対応', icon: <MessageSquare size={18} /> },
        { id: 'followup', name: '追撃・検討伺い', icon: <Clock size={18} /> },
        { id: 'reengage', name: '長期・掘り起こし', icon: <RotateCcw size={18} /> },
      ]},
      { id: 'satei', label: '一括査定対応用（Eメール）', items: [
        { id: 'satei_initial', name: '初期対応（メール）', icon: <MessageSquare size={18} /> },
        { id: 'satei_followup', name: '追客・追撃（メール）', icon: <Clock size={18} /> },
        { id: 'satei_reengage', name: '長期・掘り起こし（メール）', icon: <RotateCcw size={18} /> },
      ]},
      { id: 'satei_sms', label: '一括査定対応用（SMS）', items: [
        { id: 'satei_initial_sms', name: '初期対応（SMS）', icon: <Smartphone size={18} /> },
        { id: 'satei_followup_sms', name: '追客・追撃（SMS）', icon: <Smartphone size={18} /> },
        { id: 'satei_reengage_sms', name: '長期・掘り起こし（SMS）', icon: <Smartphone size={18} /> },
      ]}
    ];

    const ALL_CATEGORIES = CATEGORY_GROUPS.flatMap(group => group.items);

    function App() {
      const [db, setDb] = useState(null);
      const [user, setUser] = useState(null);
      const [configInput, setConfigInput] = useState("");
      const [isConfigured, setIsConfigured] = useState(() => !!localStorage.getItem("firebase_config"));
      const [templates, setTemplates] = useState([]);
      const [settings, setSettings] = useState({ mediaList: ['すまいステップ', 'リビンマッチ'], companyName: '', staffName: '', mobilePhone: '', officePhone: '' });
      const [activeCategory, setActiveCategory] = useState('satei_initial');
      const [searchQuery, setSearchQuery] = useState('');
      const [editingTemplate, setEditingTemplate] = useState(null);
      const [notification, setNotification] = useState(null);
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
      const [copyModal, setCopyModal] = useState(null);
      const [modalInputs, setModalInputs] = useState({});
      const [newMediaInput, setNewMediaInput] = useState('');

      const appId = "mail-template-app";

      useEffect(() => {
        const savedConfig = localStorage.getItem("firebase_config");
        if (savedConfig) {
          try {
            const config = JSON.parse(savedConfig);
            const app = window.FirebaseLib.initializeApp(config);
            const auth = window.FirebaseLib.getAuth(app);
            const _db = window.FirebaseLib.getFirestore(app);
            setDb(_db);
            window.FirebaseLib.signInAnonymously(auth);
            return window.FirebaseLib.onAuthStateChanged(auth, setUser);
          } catch (e) {
            localStorage.removeItem("firebase_config");
            setIsConfigured(false);
          }
        }
      }, [isConfigured]);

      useEffect(() => {
        if (!db || !user) return;
        const q = window.FirebaseLib.collection(db, 'artifacts', appId, 'public', 'data', 'templates');
        const unsubT = window.FirebaseLib.onSnapshot(q, s => setTemplates(s.docs.map(d => ({id: d.id, ...d.data()}))));
        const sRef = window.FirebaseLib.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
        const unsubS = window.FirebaseLib.onSnapshot(sRef, d => d.exists() && setSettings(d.data()));
        return () => { unsubT(); unsubS(); };
      }, [db, user]);

      const handleConfigSubmit = () => {
        try {
          // 入力された文字列から必要な情報（キーと値）を強制的に抽出する処理
          let apiKey = configInput.match(/apiKey[s"':]+([^"',s}]+)/i);
          let authDomain = configInput.match(/authDomain[s"':]+([^"',s}]+)/i);
          let projectId = configInput.match(/projectId[s"':]+([^"',s}]+)/i);
          let storageBucket = configInput.match(/storageBucket[s"':]+([^"',s}]+)/i);
          let messagingSenderId = configInput.match(/messagingSenderId[s"':]+([^"',s}]+)/i);
          let appIdValue = configInput.match(/appId[s"':]+([^"',s}]+)/i);

          if (!apiKey || !projectId || !appIdValue) {
            throw new Error("必要な項目が見つかりません。");
          }

          const extractedConfig = {
            apiKey: apiKey[1],
            authDomain: authDomain ? authDomain[1] : "",
            projectId: projectId[1],
            storageBucket: storageBucket ? storageBucket[1] : "",
            messagingSenderId: messagingSenderId ? messagingSenderId[1] : "",
            appId: appIdValue[1]
          };

          localStorage.setItem("firebase_config", JSON.stringify(extractedConfig));
          setIsConfigured(true);
        } catch (e) {
          alert("設定値の読み取りに失敗しました。コピーした内容に不足がある可能性があります。");
          console.error(e);
        }
      };

      const saveToCloud = async (t) => {
        if (!db || !user) return;
        const id = t.id || crypto.randomUUID();
        await window.FirebaseLib.setDoc(window.FirebaseLib.doc(db, 'artifacts', appId, 'public', 'data', 'templates', id.toString()), { ...t, id });
        setEditingTemplate(null);
        showNotification("保存しました");
      };

      const deleteFromCloud = async (id) => {
        if (!window.confirm("削除しますか？")) return;
        await window.FirebaseLib.deleteDoc(window.FirebaseLib.doc(db, 'artifacts', appId, 'public', 'data', 'templates', id.toString()));
      };

      const updateSettings = async (s) => {
        setSettings(s);
        if (db && user) await window.FirebaseLib.setDoc(window.FirebaseLib.doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), s);
      };

      const showNotification = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };

      const executeCopy = (text, label) => {
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        showNotification(`${label}をコピーしました`);
      };

      const handleCopyRequest = (text, label) => {
        const matches = text.match(/［.+?］/g);
        if (matches) {
          const unique = [...new Set(matches)];
          setModalInputs(Object.fromEntries(unique.map(ph => [ph, ''])));
          setCopyModal({ text, label, placeholders: unique });
        } else {
          executeCopy(text, label);
        }
      };

      if (!isConfigured) {
        return (
          <div className="min-h-screen bg-slate-900 text-white flex items-center justify-center p-6">
            <div className="max-w-md w-full bg-slate-800 p-8 rounded-2xl shadow-2xl">
              <h2 className="text-2xl font-bold mb-4">Firebaseの設定</h2>
              <p className="text-slate-400 text-sm mb-6">Firebase Consoleでコピーした構成コードを貼り付けてください。形式が多少崩れていても自動で読み取ります。</p>
              <textarea 
                className="w-full h-48 p-4 bg-slate-900 border border-slate-700 rounded-lg font-mono text-xs mb-4 focus:ring-2 focus:ring-orange-500 outline-none"
                placeholder="apiKey: 'AIzaSy...',\nauthDomain: '...',\n..."
                value={configInput}
                onChange={e => setConfigInput(e.target.value)}
              />
              <button onClick={handleConfigSubmit} className="w-full bg-orange-600 py-3 rounded-lg font-bold hover:bg-orange-500 transition-colors">設定を保存して開始</button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-[100dvh] bg-gray-50 flex flex-col md:flex-row relative">
          {isMobileMenuOpen && <div className="fixed inset-0 bg-slate-900/50 z-40 md:hidden backdrop-blur-sm" onClick={() => setIsMobileMenuOpen(false)} />}
          
          <aside className={`fixed pt-safe inset-y-0 left-0 z-50 w-72 bg-slate-800 text-white flex flex-col transform transition-transform duration-300 md:relative md:translate-x-0 md:w-64 ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="p-6 mt-safe flex justify-between items-center">
              <h1 className="text-xl font-bold flex items-center gap-2 text-orange-400"><Send size={24} /> Mail Cloud</h1>
              <button className="md:hidden" onClick={() => setIsMobileMenuOpen(false)}><X size={24} /></button>
            </div>
            <nav className="px-2 pb-4 overflow-y-auto flex-1 custom-scrollbar">
              {CATEGORY_GROUPS.map(group => (
                <div key={group.id} className="mb-6">
                  {group.label && <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-widest mb-2 px-4">{group.label}</h3>}
                  <div className="space-y-1">
                    {group.items.map(cat => (
                      <button key={cat.id} onClick={() => { setActiveCategory(cat.id); setEditingTemplate(null); setIsMobileMenuOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm transition-colors ${activeCategory === cat.id ? 'bg-orange-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
                        {cat.icon}{cat.name}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </nav>
            <div className="p-4 border-t border-slate-700 pb-safe">
              <button onClick={() => { setEditingTemplate({ title: '', category: activeCategory==='all'?'satei_initial':activeCategory, subject: '', body: '' }); setIsMobileMenuOpen(false); }} className="w-full bg-emerald-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 font-bold"><Plus size={18} /> 新規作成</button>
            </div>
          </aside>

          <main className="flex-1 h-[100dvh] overflow-hidden flex flex-col relative pt-safe">
            <header className="bg-white border-b p-4 shadow-sm z-10 sticky top-0">
              <div className="max-w-5xl mx-auto flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                <div className="flex items-center gap-3">
                  <button className="md:hidden p-2 text-gray-600" onClick={() => setIsMobileMenuOpen(true)}><Menu size={24} /></button>
                  <h2 className="text-lg font-bold">{ALL_CATEGORIES.find(c => c.id === activeCategory)?.name || 'すべて'}</h2>
                </div>
                <div className="relative w-full sm:w-80">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18} />
                  <input type="text" placeholder="検索..." className="w-full pl-10 pr-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-orange-500" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                </div>
              </div>
            </header>

            <div className="flex-1 overflow-y-auto bg-gray-50 pb-safe px-4 md:px-6">
              {!editingTemplate && (
                <div className="bg-white border-b -mx-4 md:-mx-6 mb-4 px-4 md:px-6 py-3">
                  <details className="group">
                    <summary className="cursor-pointer font-bold text-gray-700 flex items-center justify-between outline-none">
                      <span className="flex items-center gap-2"><Settings size={18} className="text-orange-500" /> 基本設定（全デバイス同期）</span>
                      <ChevronDown className="group-open:rotate-180 transition-transform text-gray-400" size={18} />
                    </summary>
                    <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 pb-2">
                      {[['自社名', 'companyName'], ['担当者名', 'staffName'], ['携帯', 'mobilePhone'], ['事務所', 'officePhone']].map(([label, key]) => (
                        <div key={key}>
                          <label className="block text-[10px] font-bold text-gray-400 mb-1">{label}</label>
                          <input type="text" value={settings[key]} onChange={e => updateSettings({...settings, [key]: e.target.value})} className="w-full p-2 border rounded text-sm outline-none focus:ring-1 focus:ring-orange-500" />
                        </div>
                      ))}
                    </div>
                  </details>
                </div>
              )}

              <div className="max-w-5xl mx-auto mt-4">
                {editingTemplate ? (
                  <Editor template={editingTemplate} onSave={saveToCloud} onCancel={() => setEditingTemplate(null)} categories={CATEGORY_GROUPS} />
                ) : (
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-20">
                    {templates.filter(t => (activeCategory === 'all' || t.category === activeCategory) && (t.title.includes(searchQuery)||t.body.includes(searchQuery))).map(t => (
                      <TemplateCard key={t.id} template={{...t, subject: t.subject.replace(/［自社名］/g, settings.companyName).replace(/［担当者名］/g, settings.staffName).replace(/［携帯電話番号］/g, settings.mobilePhone).replace(/［事務所電話番号］/g, settings.officePhone), body: t.body.replace(/［自社名］/g, settings.companyName).replace(/［担当者名］/g, settings.staffName).replace(/［携帯電話番号］/g, settings.mobilePhone).replace(/［事務所電話番号］/g, settings.officePhone)}} originalTemplate={t} onCopy={handleCopyRequest} onEdit={setEditingTemplate} onDelete={deleteFromCloud} getCategoryName={id => ALL_CATEGORIES.find(c => c.id === id)?.name} />
                    ))}
                  </div>
                )}
              </div>
            </div>

            {notification && <div className="absolute bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 animate-fade-in-up z-50"><Check size={16} className="text-green-400" />{notification}</div>}

            {copyModal && (
              <div className="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in-up">
                <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6 flex flex-col max-h-[90vh]">
                  <h3 className="text-lg font-bold mb-4">未入力項目の設定</h3>
                  <div className="overflow-y-auto flex-1 space-y-4 pr-2 mb-4">
                    {copyModal.placeholders.map((ph, idx) => (
                      <div key={idx} className="bg-gray-50 p-4 rounded-lg border">
                        <label className="block text-xs font-bold text-gray-500 mb-2">{ph}</label>
                        {ph === '［媒体名］' ? (
                          <div>
                            <div className="flex flex-wrap gap-2 mb-3">
                              {settings.mediaList.map((m, i) => (
                                <button key={i} onClick={() => setModalInputs({...modalInputs, [ph]: m})} className={`px-3 py-2 text-sm font-bold rounded-lg border ${modalInputs[ph]===m?'bg-orange-600 text-white border-orange-600 shadow-md':'bg-white text-orange-600 border-orange-200'}`}>{m}</button>
                              ))}
                            </div>
                            <div className="flex gap-2">
                              <input type="text" value={newMediaInput} onChange={e => setNewMediaInput(e.target.value)} className="flex-1 p-2 border rounded text-sm outline-none" placeholder="新しい媒体を追加" />
                              <button onClick={() => { if(!newMediaInput) return; updateSettings({...settings, mediaList: [...settings.mediaList, newMediaInput]}); setNewMediaInput(''); }} className="px-4 py-2 bg-slate-800 text-white rounded text-xs font-bold">追加</button>
                            </div>
                          </div>
                        ) : (
                          <input type="text" value={modalInputs[ph]} onChange={e => setModalInputs({...modalInputs, [ph]: e.target.value})} className="w-full p-2 border rounded outline-none text-sm focus:ring-1 focus:ring-orange-500" placeholder="内容を入力してください" />
                        )}
                      </div>
                    ))}
                  </div>
                  <div className="flex justify-end gap-3 pt-4 border-t">
                    <button onClick={() => setCopyModal(null)} className="px-5 py-2 text-gray-400 font-bold">中止</button>
                    <button onClick={() => {
                      let res = copyModal.text;
                      copyModal.placeholders.forEach(ph => { res = res.split(ph).join(modalInputs[ph] || ph); });
                      executeCopy(res, copyModal.label); setCopyModal(null);
                    }} className="px-6 py-2 bg-orange-600 text-white rounded shadow-md flex items-center gap-2 font-bold"><Copy size={16} /> コピー実行</button>
                  </div>
                </div>
              </div>
            )}
          </main>
        </div>
      );
    }

    function TemplateCard({ template, originalTemplate, onCopy, onEdit, onDelete, getCategoryName }) {
      return (
        <div className="bg-white rounded-xl shadow-sm border hover:shadow-md transition-shadow flex flex-col h-full overflow-hidden">
          <div className="p-4 border-b bg-gray-50/50 flex justify-between items-start">
            <div><span className="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-orange-100 text-orange-700 mb-1">{getCategoryName(template.category)}</span><h3 className="font-bold text-gray-800 leading-tight">{template.title}</h3></div>
            <div className="flex gap-1"><button onClick={() => onEdit(originalTemplate)} className="p-2 text-gray-400 hover:text-blue-600"><Edit2 size={18} /></button><button onClick={() => onDelete(template.id)} className="p-2 text-gray-400 hover:text-red-600"><Trash2 size={18} /></button></div>
          </div>
          <div className="p-4 flex-1 space-y-4">
            <div><div className="text-[10px] font-bold text-gray-400 mb-1 flex justify-between">件名<button onClick={() => onCopy(template.subject, '件名')} className="text-orange-600 font-bold flex items-center gap-1"><Copy size={10} />コピー</button></div><div className="bg-gray-50 p-2 rounded border text-sm text-gray-700 font-medium break-all">{template.subject || '(件名なし)'}</div></div>
            <div><div className="text-[10px] font-bold text-gray-400 mb-1 flex justify-between">本文<button onClick={() => onCopy(template.body, '本文')} className="text-orange-600 font-bold flex items-center gap-1"><Copy size={10} />コピー</button></div><div className="bg-gray-50 p-3 rounded border text-sm text-gray-600 font-mono whitespace-pre-wrap h-40 overflow-y-auto custom-scrollbar">{template.body}</div></div>
          </div>
        </div>
      );
    }

    function Editor({ template, onSave, onCancel, categories }) {
      const [formData, setFormData] = useState({ ...template });
      const bodyRef = useRef(null);
      const insert = ph => {
        const start = bodyRef.current.selectionStart;
        const end = bodyRef.current.selectionEnd;
        const body = formData.body || '';
        setFormData({...formData, body: body.substring(0, start) + ph + body.substring(end)});
        setTimeout(() => { bodyRef.current.selectionStart = bodyRef.current.selectionEnd = start + ph.length; bodyRef.current.focus(); }, 0);
      };

      return (
        <div className="bg-white rounded-xl shadow-lg border overflow-hidden animate-fade-in-up">
          <div className="bg-slate-800 text-white px-6 py-4 flex justify-between items-center"><h3 className="font-bold">{template.id?'編集':'新規作成'}</h3><button onClick={onCancel}><X size={24} /></button></div>
          <form onSubmit={e => { e.preventDefault(); onSave(formData); }} className="p-6 space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div><label className="block text-xs font-bold text-gray-400 mb-1">タイトル</label><input type="text" className="w-full p-2 border rounded font-bold" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} required /></div>
              <div><label className="block text-xs font-bold text-gray-400 mb-1">カテゴリ</label><select className="w-full p-2 border rounded bg-white font-bold" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})}>{categories.map(g => g.id!=='general'&&<optgroup key={g.id} label={g.label}>{g.items.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</optgroup>)}</select></div>
            </div>
            <div><label className="block text-xs font-bold text-gray-400 mb-1">件名</label><input type="text" className="w-full p-2 border rounded font-bold" value={formData.subject} onChange={e => setFormData({...formData, subject: e.target.value})} /></div>
            <div>
              <div className="flex flex-wrap gap-2 mb-2">
                {['［お客様名］', '［媒体名］', '［物件のエリア・種別］', '［自社名］', '［担当者名］'].map(ph => (
                  <button key={ph} type="button" onClick={() => insert(ph)} className="text-[10px] bg-white border border-blue-200 text-blue-600 px-2 py-1 rounded shadow-sm font-bold">{ph}</button>
                ))}
              </div>
              <textarea ref={bodyRef} className="w-full h-64 p-3 border rounded font-mono text-sm outline-none focus:ring-2 focus:ring-orange-500 custom-scrollbar" value={formData.body} onChange={e => setFormData({...formData, body: e.target.value})} required /></div>
            <div className="flex justify-end gap-3"><button type="button" onClick={onCancel} className="px-5 py-2 text-gray-500 font-bold">中止</button><button type="submit" className="px-8 py-2 bg-orange-600 text-white rounded shadow-md font-bold">保存してクラウド同期</button></div>
          </form>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
